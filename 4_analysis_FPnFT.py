import sys
import json
import os
import pandas as pd 
import csv
#* ------------------------------------------------------
#*       
#*       Use json file from argv[1] to get initial precision, recall, f1 , sample number and accuracy 
#*       Fetch two txt files from argv[2] to get final  FP and FN number.
#*       Then, this program will use abovementioned file to calculate final result of an ensembled model
#*
#* -------------------------------------------------------

def all_json_list(path):
    if not path.endswith('/'):
        path= path +'/'
    
    json_list=[]
    for dirpath,dirname,filename in os.walk(path):
        for f in filename:
            if  f.endswith(".json"):
                file_path = dirpath+f
                json_list.append(file_path)    
    return json_list

def all_txt_list(path):
    if not path.endswith('/'):
        path= path +'/'
    
    txt_list=[]
    for dirpath,dirname,filename in os.walk(path):
        for f in filename:
            if  f.endswith(".txt"):
                file_path = dirpath+f
                txt_list.append(file_path)    
    return txt_list

def all_csv_list(path):
    if not path.endswith('/'):
        path= path +'/'
    
    csv_list=[]
    for dirpath,dirname,filename in os.walk(path):
        for f in filename:
            if  f.endswith(".csv"):
                file_path = dirpath+f
                csv_list.append(file_path)    
    return csv_list

def down_level_for_path(path):
    if not path.endswith('/'):
        path = path+'/'
    last_folder = path.split('/')[-2]
    length = len(last_folder)+1

    return path[0:(-1* length)]

if __name__ == "__main__":
    
    input_path = sys.argv[1]
    all_data = sys.argv[2]

    label_name = input_path.split('/')[-3]
    print(input_path)

    json_file = all_json_list(input_path)
    txt_file = all_txt_list(all_data)
    csv_file = all_csv_list(all_data)
    print(txt_file)
    print(csv_file)
    print(json_file)
    

    j_file = open(json_file[0])
    j_data = json.load(j_file)

    
    sample_number = j_data['All_parameter']['For_all']['X.test_num']
    acc = j_data['Each_accuracy']['Round_1'][j_data['Each_f1']['Round_1'].keys()[0]]
    pre = j_data['Each_precision']['Round_1'][j_data['Each_f1']['Round_1'].keys()[0]]
    recall = j_data['Each_recall']['Round_1'][j_data['Each_precision']['Round_1'].keys()[0]]
    f1 = j_data['Each_f1']['Round_1'][j_data['Each_precision']['Round_1'].keys()[0]]

    FP=0
    FN=0

    for txt in txt_file:
        t_file = open(txt)
        first_line = t_file.readline()
        if  'FP' in txt.split('_'):
            FP = int(first_line)
        if  'FN' in txt.split('_'):
            FN = int(first_line)
        t_file.close()

    for csv in csv_file:
        if 'FP' in csv.split('_'):
            try : 
                FP_csv = pd.Series.from_csv(csv)
                final_FP = len(FP_csv)
            except pd.errors.EmptyDataError:
                final_FP =0

        if 'FN' in csv.split('_'):
            try :
                FN_csv = pd.Series.from_csv(csv)
                final_FN = len(FN_csv)
            except pd.errors.EmptyDataError:
                final_FN = 0
    j_file.close()

    print('sample_number = %d' %sample_number)
    print('acc = %0.6f  '%acc)
    print('precision = %0.6f  '%pre)
    print('Recall =  %0.6f'%(recall))
    print('initial FP = %d' %FP)
    print('initial FN = %d' %FN)
    print('final FP = %d' %final_FP)
    print('final FN = %d' %final_FN)

    initial_TPnTN = sample_number*acc
    try :
        initial_TP = (pre*FP)/(1-pre)
    except ZeroDivisionError:
        initial_TP = (recall*FN)/(1-recall)
    print(initial_TP)
    initial_TN = initial_TPnTN - initial_TP
    print('initial_TP = %.6f' %(initial_TP) )
    print('initial_TN = %.6f' %(initial_TN) )
    print('---------------new----------------')

    final_TP = initial_TP + FN - final_FN
    final_TN = initial_TN + FP - final_FP

    print('final_TP = %d' %(final_TP))
    print('final_TN = %d' %(final_TN))

    final_acc = (final_TP+final_TN)/sample_number
    final_pre = final_TP/(final_TP+final_FP)
    final_recall =final_TP/(final_TP+final_FN) 


    print('sample number = %d'%(final_TN+final_TP + final_FP + final_FN ))
    print('New acc = %.6f'%((final_TP+final_TN)/sample_number))
    print('New pre = %.6f'%(final_TP/(final_TP+final_FP)))
    print('New recall = %.6f'%( final_TP/(final_TP+final_FN) ))
    print(label_name)

    if not all_data.endswith('/'):
        all_data = all_data+'/'
    new_path = down_level_for_path(all_data)
    json_saving = new_path+label_name+'_summary_.json'
    csv_saving = new_path+label_name+'_summary_.csv'
    final_dict = {'pre':{'pre':pre, 'recall':recall, 'acc':acc, 'TP':initial_TP, 'TN':initial_TN, 'FP':FP, 'FN':FN, 'sample_number':sample_number}, 'af':{'pre':final_pre, 'recall':final_recall, 'acc':final_acc, 'TP':final_TP, 'TN':final_TN, 'FP':final_FP, 'FN':final_FN, 'sample_number':sample_number}}

    with open(csv_saving, 'w') as c_file:
        for key in final_dict.keys():
            for key_2 in final_dict[key]:
                c_file.write("%s,%s,%s\n"%(key,key_2,final_dict[key][key_2]))
    jsonfile = open(json_saving, 'w+')
    jsonfile.write(json.dumps(final_dict))
    jsonfile.close()